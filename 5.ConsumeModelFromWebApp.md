# Consume trained model from a .NET application using gRPC protocol

Let's start with the final result so we can imagine what is our target here.

![final-result.png](./images/final-result.png)

The final result is a web application hosted locally or in Azure.
You can find the source code of this application [here](./WebApp)
 Pretty lame UI but all we need is a file select button to upload an image. Uploaded image will be fed to the prediction service served by TensorFlow Serving (too much serving here but cannot help it). Anyway, prediction result is two probabilities one for cat and one for dog and based on their values we will show the dog/cat label. 

e.g. If dog probability is 95% then cat probability by definition will be 5% and we will show a dog label with 95% probability.

Just to get an idea of the design of this application:

* Front end is a simple Angular 1.x simple app with Bootstrab styling
* Backend is ASP.NET Web API that saves images and predictions to SQL database
* ORM is EF using the old style load model from database approach
* Prediction is done by C# proxy classes generated by gRPC nuget package, I will come to that later.

Let's discuss some of the above in more detail.

## Calling TensorFlow Serving

TensorFlow Serving exposes models via a Google developed protocol called gRPC. gRPC is a high performance, open-source universal RPC framework that is used extensively by Google. Fortunately there is support for many languages and for C# we have the needed nuget libraries to act as a server or as a client for gRPC. For our case we need to generate client proxy classes to call TensorFlow Serving. If you remeber the tools to generate proxy classes from WSDL or WCF definition then I can stop here. Simply, there is a tool to feed with service definition (called protocol buffers) and it will outcome client proxy classes. I have already done this step but if you want more details here you go.

Protcol buffer files for TensorFlow Serving can be found in [here](https://github.com/tensorflow/serving/tree/master/tensorflow_serving/apis).

A cleaner copy that is easy to work with can be found in [this](https://github.com/krystianity/keras-serving/tree/master/node_server/protos) GitHub repo. It simply the same files from Google TensorFlow Serving but kind of self contained so you do not need to handle references to other Google repos/libraries.

Once you download those protocol buffer files you can process them with the command below to generate C# client proxy classes:

```
protoc.exe "prediction_service.proto" "predict.proto" "model.proto" "resource_handle.proto"   --csharp_out "C:\Temp" --grpc_out "C:\Temp" --plugin=protoc-gen-grpc=packages\Grpc.Tools.1.4.1\tools\windows_x86\grpc_csharp_plugin.exe
```

Once you restore all the nuger packages of the web application, those protoc.exe & grpc_csharp_plugin.exe will be available in packages folder.

For more details on gRPC with C# please have a look on [gRPC C# quick guide](https://grpc.io/docs/quickstart/csharp.html).


